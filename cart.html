<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - ECOBuy</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script> </head>
<body>

    <header>
        <div class="logo"><a href="index.html">ECOBuy</a></div>
        <nav>
            <a href="shop.html">Shop</a>
            <a href="index.html#promise">Our Mission</a>
            <a href="cart.html" class="cart-icon active">üõí Cart (<span id="cart-count">0</span>)</a> 
        </nav>
    </header>

    <main class="cart-page">
        <h2>Your Shopping Cart</h2>

        <div class="checkout-layout">

            <div class="checkout-details">

                <section class="cart-items-section">
                    <h3>Items in your Cart (<span id="cart-item-count">0</span>)</h3>
                    <div id="cart-items-display">
                        <p id="empty-cart-message" style="display:none;">Your cart is empty. <a href="shop.html">Start Shopping!</a></p>
                    </div>
                    
                    <button id="clear-cart-btn" class="cta-button secondary" style="margin-top: 15px; margin-right: 15px;">
                        üóëÔ∏è Clear Cart
                    </button>

                    <a href="shop.html" class="back-to-shop">‚Üê Continue Shopping</a>
                </section>

                <section class="address-section">
                    <h3>Delivery Address</h3>
                    <form id="address-form">
                        <input type="text" id="fullName" placeholder="Full Name" required>
                        <input type="text" id="houseNo" placeholder="House/Flat No, Building" required>
                        <input type="text" id="street" placeholder="Street Name, Locality" required>
                        <input type="text" id="pincode" placeholder="Pincode (e.g., 411001)" pattern="[0-9]{6}" required>
                        <input type="text" id="cityState" placeholder="City, State" required>
                        <input type="tel" id="mobileNo" placeholder="Mobile Number" pattern="[0-9]{10}" required>
                    </form>
                </section>

            </div>

            <section class="price-summary">
                <h3>Order Summary</h3>
                <div class="price-line">
                    <span>Subtotal:</span>
                    <span id="subtotal-price">‚Çπ0.00</span>
                </div>
                <div class="price-line">
                    <span>Shipping:</span>
                    <span class="free">FREE (Carbon Neutral)</span>
                </div>
                
                <div class="total-line">
                    <span>Grand Total:</span>
                    <span id="grand-total-price">‚Çπ0.00</span>
                </div>
                
                <button id="place-order-btn" class="cta-button primary">Proceed to Payment</button>
                <p class="order-status" id="order-placed-message" style="display:none;">
                    üéâ Your order has been placed successfully! Redirecting...
                </p>
            </section>

        </div>
    </main>

    <footer>
        <p>&copy; 2025 ECOBuy. All rights reserved. | Sustainable & Ethical.</p>
    </footer>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

        // --- Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyDWLJdtfVa4AURsXgjYubaQjj0Ov5cEWhs", // REPLACE WITH YOUR KEY
            authDomain: "ecobuy-5ed1d.firebaseapp.com",
            projectId: "ecobuy-5ed1d",
            storageBucket: "ecobuy-5ed1d.appspot.com",
            messagingSenderId: "127724558905",
            appId: "1:127724558905:web:e251dde3d4bb8c521b4be8"
        };
        const RAZORPAY_KEY_ID = "rzp_test_XXXXXXXXXXXXXXXX"; // ‚ö†Ô∏è REPLACE WITH YOUR RAZORPAY TEST/LIVE KEY!
        const CURRENCY_CODE = "INR";
        const COMPANY_NAME = "ECOBuy Sustainable Marketplace";

        // --- Initialization ---
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const ordersCollection = collection(db, "orders");

        // --- DOM Elements ---
        const cartCountSpan = document.getElementById('cart-count');
        const cartItemsDisplay = document.getElementById('cart-items-display');
        const cartItemCountSpan = document.getElementById('cart-item-count');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const placeOrderBtn = document.getElementById('place-order-btn');
        const addressForm = document.getElementById('address-form');
        const orderPlacedMessage = document.getElementById('order-placed-message');
        const subtotalSpan = document.getElementById('subtotal-price');
        const grandTotalSpan = document.getElementById('grand-total-price');
        const clearCartBtn = document.getElementById('clear-cart-btn');

        let cart = JSON.parse(localStorage.getItem('cart')) || [];
        let cartTotal = 0;

        // --- Display & Total Calculation ---
        function updateCartDisplay() {
            cartItemsDisplay.innerHTML = '';
            let totalItems = 0;
            cartTotal = 0; // Reset total

            if (cart.length === 0) {
                emptyCartMessage.style.display = 'block';
                placeOrderBtn.disabled = true;
            } else {
                emptyCartMessage.style.display = 'none';
                cart.forEach(item => {
                    const subtotal = item.price * item.quantity;
                    const div = document.createElement('div');
                    div.classList.add('cart-item');
                    
                    div.innerHTML = `
                        <div style="flex-grow: 1;">
                            <h4>${item.name}</h4>
                            <p>Price: ‚Çπ${item.price} x Qty: ${item.quantity} = **‚Çπ${subtotal.toFixed(2)}**</p>
                            
                            <button class="remove-btn" data-id="${item.id}">Remove</button> 
                        </div>
                    `;
                    cartItemsDisplay.appendChild(div);
                    totalItems += item.quantity;
                    cartTotal += subtotal; 
                });
                placeOrderBtn.disabled = false;
            }

            // Update Summary
            subtotalSpan.textContent = `‚Çπ${cartTotal.toFixed(2)}`;
            grandTotalSpan.textContent = `‚Çπ${cartTotal.toFixed(2)}`; 
            
            // Update Header Count
            cartCountSpan.textContent = totalItems;
            cartItemCountSpan.textContent = totalItems;
            
            // Re-attach listeners every time the cart is re-rendered
            attachRemoveListeners(); 
        }

        // --- Remove Item Logic ---
        function removeItem(itemId) {
            // Filter the current cart array: keep all items whose ID does NOT match the item to be removed.
            cart = cart.filter(item => item.id !== itemId); 

            // Save the new array back to localStorage
            localStorage.setItem('cart', JSON.stringify(cart)); 
            
            // Re-render the cart display and totals
            updateCartDisplay();
        }

        // --- Attach Remove Listeners ---
        function attachRemoveListeners() {
            document.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', (event) => {
                    const itemId = event.target.dataset.id;
                    removeItem(itemId);
                });
            });
        }


        // --- Order Submission (After Successful Payment) ---
        async function submitOrderToFirebase(paymentId) {
            const address = {
                fullName: document.getElementById("fullName").value,
                houseNo: document.getElementById("houseNo").value,
                street: document.getElementById("street").value,
                pincode: document.getElementById("pincode").value,
                cityState: document.getElementById("cityState").value,
                mobileNo: document.getElementById("mobileNo").value
            };

            const order = {
                items: cart,
                address: address,
                total: cartTotal,
                timestamp: new Date(),
                payment: {
                    gateway: "Razorpay",
                    id: paymentId,
                    status: "Paid"
                }
            };

            try {
                await addDoc(ordersCollection, order);
                orderPlacedMessage.style.display = 'block';
                localStorage.removeItem('cart');
                updateCartDisplay(); 
                setTimeout(() => window.location.href = "index.html", 3000);
            } catch (error) {
                console.error("Error placing order:", error);
                alert("Order recorded but payment confirmation failed. Contact support with payment ID.");
            }
        }


        // --- Event Listeners ---
        
        // 1. Razorpay Payment Trigger
        placeOrderBtn.addEventListener('click', async () => {
            if (!addressForm.checkValidity() || cart.length === 0 || cartTotal === 0) {
                alert("Please fill all required address fields and ensure your cart is not empty!");
                addressForm.reportValidity();
                return;
            }
            
            placeOrderBtn.disabled = true;
            placeOrderBtn.textContent = 'Processing...';

            // Amount must be in Paisa
            const amountInPaisa = Math.round(cartTotal * 100); 

            const options = {
                key: RAZORPAY_KEY_ID, 
                amount: amountInPaisa,
                currency: CURRENCY_CODE,
                name: COMPANY_NAME,
                description: "Sustainable Herbal Products Order",
                image: "path/to/your/logo.png", 
                handler: function (response) {
                    submitOrderToFirebase(response.razorpay_payment_id);
                },
                prefill: {
                    name: document.getElementById("fullName").value,
                    contact: document.getElementById("mobileNo").value,
                },
                theme: {
                    color: "#4CAF50" // Primary Green
                }
            };

            try {
                const rzp = new window.Razorpay(options);
                rzp.on('payment.failed', function (response){
                    alert(`Payment Failed: ${response.error.description}`);
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.textContent = 'Proceed to Payment';
                });
                rzp.open();
            } catch(e) {
                 alert("Could not start payment process. Check Razorpay Key.");
                 placeOrderBtn.disabled = false;
                 placeOrderBtn.textContent = 'Proceed to Payment';
            }
        });
        
        // 2. Clear Cart Button Functionality
        clearCartBtn.addEventListener('click', () => {
            if (confirm("Are you sure you want to clear your cart?")) {
                localStorage.removeItem('cart');
                cart = []; 
                updateCartDisplay(); 
            }
        });

        // Initial render and listener attachment
        updateCartDisplay(); 
    </script>
</body>
</html>